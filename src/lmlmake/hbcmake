#! /bin/sh
# hbcmake - make for Haskell programs
# Author: Thomas Hallgren, hallgren@cs.chalmers.se

LMLDIR=${HBCDIR-${LMLDIR-/usr/local/lib/lmlc}}
lib=$LMLDIR/bin

exec='sh -e'    # What to do with the commands generated by lmlmk.
hversion="-1.3" # Which version of Haskell?

modules=       # modules to compile/link
flags=         # flags for lmlmk
rtflags=       # run-time flags for lmlmk
xdgflags=      # flags for xhbdg

LMLINCLUDE=.	# list of source directories (misleading var name!!)

if [ "$HBCINCPATH" = "" ] ; then
  usestdlibs=yes
  # Standard libraries will be appended to HBCINCPATH
else
  usestdlibs=no
  # Imported HBCINCPATH is assumed to contain all needed library directories
fi

while [ $# != 0 ]; do
  case $1 in
    -1.2) hversion="-1.2" ;;
    -1.3) hversion="-1.3" ;;
    -xdg)
      # Show dependency graph with xhbdg instead of compiling
      xdg=yes ;;
    -[tg])
      quiet=yes
      exec=cat
      flags="$flags $1" ;;
    -[Pn]|-debug)
      exec=cat
      flags="$flags $1" ;;
    -s)
      flags="$flags $1" ;;
    -[AHhBSX]*|-gc*)
      #Any more useful run-time flags?
      rtflags="$rtflags $1" ;;
    -f)
      shift
      makefile=$1 ;;
    -d)
      #-d switches on distributed make. Needs distcom to work.
      LMLMKDISTR=yes ;;
    -C)
      shift
      HBCFLAGS="$HBCFLAGS $1" ;;
    -nd|-strip) strip=yes ;;
    -nostrip) strip=no ;;
    -[xy]space)
      xdgflags="$xdgflags $1 $2"
      shift
      ;;
    -o)
      shift
      LDFLAGS="$LDFLAGS -o $1"
      ;;
    *.so|*.a|-l*) LDFLAGS="$LDFLAGS $1" ;;
    -i) usestdlibs=no ;;
    -i*) HBCINCPATH="`echo $1 | sed -e s/-i//`:$HBCINCPATH" ;;
    -I)
      shift
      LMLINCLUDE="${LMLINCLUDE}:$1"
      HBCFLAGS="$HBCFLAGS -i$1"	# should not be used when linking !!!
      ;;
    -T)
      HBCFLAGS="$HBCFLAGS $1"
      strip=no
      ;;
    -*) HBCFLAGS="$HBCFLAGS $1" ;;
    *)
      modules="$modules $1"
      ;;
  esac
  shift
done

if [ $usestdlibs = yes ]; then
  if [ $hversion = "-1.2" ]; then
    HBCINCPATH="$HBCINCPATH":.:$LMLDIR/hbc_library
  else
    HBCINCPATH="$HBCINCPATH":.:$LMLDIR/hbc_library1.3:$LMLDIR/hlib1.3/
  fi
fi

if [ ${strip-yes} = yes ]; then
  LDFLAGS="$LDFLAGS -s"
fi

if [ "$modules" = "" ] ; then
  echo 'Usage: hbcmake [flags] modules'
  exit 1
fi

defmakefile=Makefile
[ -r $defmakefile ] || defmakefile=makefile
makefile=${makefile-$defmakefile}

# Also try to extract compiler/linker flags from a Makefile
if [ -r $makefile ]; then
  HBCFLAGS="$HBCFLAGS `grep '^[ ]*HBCFLAGS[ 	]*=' $makefile | sed 's/.*=//'`"
  LDFLAGS="$LDFLAGS `grep '^[ ]*LDFLAGS[ 	]*=' $makefile | sed 's/.*=//'`"
fi

HBCFLAGS="$hversion $HBCFLAGS"

HBC=${HBC-hbc}
LMLMK_LANG=hbc
LMLMK=${LMLMK-$lib/lmlmk}
OLDER=${OLDER-$lib/older}

[ -x $LMLMK ] || LMLMK=/usr/local/lib/lmlc/bin/lmlmk
[ -x $OLDER ] || OLDER=/usr/local/lib/lmlc/bin/older

export HBC
export LMLMK_LANG
export HBCINCPATH
export LMLINCLUDE
export HBCFLAGS
export LDFLAGS
export OLDER
if [ "$LMLMKDISTR" = "yes" ]; then
  export LMLMKDISTR
fi

#Here we go...
if [ ${xdg-no} = yes ]; then
  echo xhbdg $rtflags $modules $xdgflags
  xhbdg $rtflags $modules $xdgflags
else
  $LMLMK $rtflags - $flags $modules | $exec
fi
